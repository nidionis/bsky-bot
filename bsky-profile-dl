from bsky_agent import BskyAgent

async def download_profile(handle: str, limit: int = 100):
    agent = BskyAgent()
    await agent.login('username', 'password')

    # 1. Profile metadata
    profile = await agent.api.app.bsky.actor.getProfile({'actor': handle})

    # 2. Posts (paginated)
    posts = []
    cursor = None
    while True:
        resp = await agent.api.app.bsky.feed.getAuthorFeed({'actor': handle, 'limit': limit, 'cursor': cursor})
        posts.extend(resp['feed'])
        cursor = resp.get('cursor')
        if not cursor:
            break

    # 3. Likes
    likes = []
    cursor = None
    while True:
        resp = await agent.api.app.bsky.feed.getActorLikes({'actor': handle, 'limit': limit, 'cursor': cursor})
        likes.extend(resp['feed'])
        cursor = resp.get('cursor')
        if not cursor:
            break

    # 4. Followers and follows
    followers = []
    cursor = None
    while True:
        resp = await agent.api.app.bsky.graph.getFollowers({'actor': handle, 'limit': limit, 'cursor': cursor})
        followers.extend(resp['followers'])
        cursor = resp.get('cursor')
        if not cursor:
            break

    follows = []
    cursor = None
    while True:
        resp = await agent.api.app.bsky.graph.getFollows({'actor': handle, 'limit': limit, 'cursor': cursor})
        follows.extend(resp['follows'])
        cursor = resp.get('cursor')
        if not cursor:
            break

    return {
        "profile": profile,
        "posts": posts,
        "likes": likes,
        "followers": followers,
        "follows": follows,
    }


