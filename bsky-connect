#!/usr/bin/env python3
import os
import sys
import argparse
import requests

API_BASE = "https://bsky.social/xrpc"
TOKEN_DIR = os.environ.get("BSKY_TOKENS", "/tmp/skY")
DFLT_BSKY_ID = os.environ.get("BSKY_ID", "ni-bot")
DFLT_BSKY_PASSWD = os.environ.get("BSKY_PASSWD", "I suck")

def token_path(username):
    os.makedirs(TOKEN_DIR, exist_ok=True)
    return os.path.join(TOKEN_DIR, username)

def load_token(username=DFLT_BSKY_ID, password=DFLT_BSKY_PASSWD):
    path = token_path(username)
    if os.path.exists(path):
        with open(path, "r") as f:
            token = f.read().strip()
            if token:
                return token
    if password == "I suck":
        print("passwd probably missing")
    resp = requests.post(
        f"{API_BASE}/com.atproto.server.createSession",
        json={"identifier": username, "password": password}
    )
    resp.raise_for_status()
    token = resp.json().get("accessJwt")
    if not token:
        sys.exit("Failed to get JWT: check credentials")
    with open(path, "w") as f:
        f.write(token)
    return token

def connect() -> str:
    load_token()


def parse_args():
    parser = argparse.ArgumentParser(description="Authenticate with Bluesky and store per-user token")
    parser.add_argument("-u", "--user", required=True, help="Bluesky username")
    parser.add_argument("-p", "--password", help="Bluesky password (only needed first time)")
    return parser.parse_args()

def main():
    args = parse_args()
    token = load_token(args.user, args.password)
    print(f"Token stored for user '{args.user}' at {token_path(args.user)}")

if __name__ == "__main__":
    main()

